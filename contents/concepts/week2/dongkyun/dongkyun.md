# 💾 Database & JPA

---

## 공통 주제

### 🍀 ORM은 무엇일까요? 스프링에서 ORM을 어떻게 이용할 수 있을까요?

1. ORM은 무엇이고 왜 필요할까요?
    1. **ORM (Object-Relational Mapping)**은 객체 지향 프로그래밍 언어를 사용하여 호환되지 않는 유형의 시스템 간에 데이터를 변환하는 프로그래밍 기술이다. 객체와 관계형 데이터베이스의 데이터를 매핑하는 것을 의미한다.
    2. ORM을 통해 SQL 쿼리 없이 데이터베이스를 관리할 수 있다.
    3. Java에서는 Hibernate가 대표적인 ORM 라이브러리이다.

1. 스프링에서 ORM을 어떻게 활용하나요?
    1. **Spring Data JPA**란 무엇일까요?
        1. SQL 쿼리를 직접 작성하는 대신 객체와 객체 간의 관계에 집중할 수 있게 돕는 기술
        2. 반복 작성되는 메서드를 자동화하여 기본적인 CRUD 메서드를 제공하는 라이브러리
    2. **Repository Layer**란 무엇일까요?
        1. 엔티티에 의해 생성된 데이터베이스 테이블에 접근하는 메서드들을 사용하기 위한 인터페이스
        2. CRUD의 처리 방법을 정의하는 계층
    3. **JpaRepository** 인터페이스에는 어떤 기능들이 포함되어 있나요?
        1. findAll() → 해당 엔티티 테이블의 모든 데이터 조회
        2. save() → 해당 엔티티를 데이터베이스에 저장
        3. saveAll() → Iterable 가능한 (List, Set 등)의 객체를 저장
        4. delete() → 데이터베이스에서 해당 엔티티 삭제
       
![스크린샷 2025-03-29 오후 11.07.59.png](스크린샷%202025-03-29%20오후%2011.07.59.png)

### 🍀 영속성 컨택스트는 무엇일까요?

- **영속성 컨텍스트**는 JPA에서 엔티티 인스턴스를 관리하는 환경
    - 이 환경은 영속성을 관리하고 엔티티의 생명 주기를 추적하는 데 사용된다.
    - 엔티티 객체가 영속성 컨텍스트에 들어오면 JPA는 엔티티 객체의 매핑 정보를 데이터베이스에 반영하는 작업을 수행
    - 엔티티 객체가 영속성 컨텍스트에 들어와 JPA의 관리 대상이 되는 시점부터 해당 객체를 영속 객체라고 부른다.
  
![스크린샷 2025-03-29 오후 11.06.27.png](스크린샷%202025-03-29%20오후%2011.06.27.png)

1. 영속성 컨택스트의 생명주기는 어떻게 되나요?
    1. **영속성 컨텍스트**는 세션 단위의 생명주기를 가진다.
        1. 데이터베이스에 접근하기 위한 세션이 생성되면 영속성 컨텍스트가 만들어짐
        2. 세션이 종료되면 영속성 컨텍스트도 없어짐

2. 영속성 컨택스트의 특징에는 어떤게 있을까요?
    1. 1차 캐시와 동일성 보장
        1. **1차 캐시**란 영속성 컨텍스트가 가지고 있는 내부에 엔티티를 저장할 수 있는 캐시이다.
            1. 엔티티를 처음 영속성 컨텍스트에 저장하면 1차 캐시에 엔티티가 저장된다.
            2. 1차 캐시에 조회하려는 엔티티가 존재
                1. 데이터베이스를 거치지 않고 메모리 상에서 조회가 가능
            3. 1차 캐시에 없는 엔티티를 조회
                1.  먼저 1차 캐시를 조회해 엔티티를 찾고 없으므로 데이터베이스에서 조회한다. 조회한 데이터로 엔티티를 생성해 1차 캐시에 저장 후 이를 반환한다.
            4. 이는 데이터베이스에 접근할 횟수를 줄이므로 성능상 이점
                1. 그러나 엔티티 매니저는 클라이언트 요청에 응답 후 자원을 반납하게 된다. 이때 그 안에 있던 1차 캐시도 모두 지워진다. 즉, 하나의 요청에 여러 번의 엔티티를 조회하지 않는다면 1차 캐시로 얻는 이점은 거의 없다.

        2. **동일성 보장**이란 같은 트랙잭션 내의 동일한 엔티티는 항상 같은 인스턴스로 유지된다는 개념이다.
            1. 엔티티의 id 값이 같다면 계속 조회해도 새로운 객체 생성 없이 동일한 인스턴스를 반환한다.

            ```json
            Member member1 = memberRepository.findById(1L).get();
            Member member2 = memberRepository.findById(1L).get();
            ```

    2. 쓰기 지연 SQL 저장소와 변경 감지
        1. **쓰기 지연**이란 JPA의 매서드를 호출해도 데이터베이스에 쿼리를 날리지 않고, 엔티티 매니저가 SQL을 모아뒀다가 트랜잭션이 commit 될 때 한 번에 실행되는 최적화 기법이다.
            1. 영속성 컨텍스트에는 쓰기 지연 저장소가 존재한다.
            2. commit 시점에 한 번에 실행해 성능을 최적화한다.

        2. **변경 감지( Dirty Checking )**란 ORM에서 사용되는 기술로 객체의 상태가 변경되었는지 추적하고 이를 데이터베이스에 반영하는 기법이다.
            1. JPA에서는 엔티티를 수정할 때 update() 같은 메서드가 필요하지 않다. 영속성 컨텍스트 안의 엔티티를 수정하면 변경사항을 데이터베이스에 자동으로 반영해 준다.
            2. JPA는 엔티티를 영속성 컨텍스트에 보관할 때, 최초 상태를 복사해서 스냅샷으로 저장한다. 그 후 플러시 ( flush() )가 호출되는 시점에 스냅샷과 엔티티를 비교해 변경된 엔티티를 찾는다.
                1. flush()는 영속성 컨텍스트의 변경 사항을 데이터베이스에 반영하는 기능
                2. 이는 영속성 컨텍스트를 데이터베이스와 동기화하는 작업
                    1. 플러시를 호출하는 방법
                        1. 직접 호출
                        2. 트랜잭션 커밋 시 자동 호출
                        3. JPQL 쿼리 실행 시 자동 호출

![스크린샷 2025-03-29 오후 11.08.46.png](스크린샷%202025-03-29%20오후%2011.08.46.png)

### 🍀 연관관계 매핑은 무엇이고 어떻게 활용할 수 있을까요?

1. 연관관계 매핑은 왜 필요할까요?
    1. **연관관계 매핑**이란 객체 지향 프로그래밍에서 객체 간의 관계를 표현하는 것이다.
        1. 이를 통해 객체 간의 관계를 사용하여 데이터베이스 테이블 간의 데이터 결합을 처리할 수 있다.

1. 연관관계 매핑에는 어떤 종류가 있을까요?
    1. 관계
        1. @OneToOne → 일대일 관계
        2. @OneToMany → 일대다 관계
        3. @ManyToOne → 다대일 관계
        4. @ManyToMany → 다대다 관계
    2. 방향
        1. 단방향 매핑 → 한 개의 엔티티에서만 다른 엔티티에 대한 참조가 가능한 경우
            1. 참조가 가능한 부모 엔티티에만 @OneToMany와 같은 어노테이션을 사용한다.
        2. 양방향 매핑 → 두 개의 엔티티에서 각각 다른 엔티티에 대한 참조가 가능한 경우
            1. 각각의 엔티티에 @OneToMany / @ManyToOne와 같은 어노테이션을 사용한다.

2. 영속성 전이는 무엇이고 어떻게 활용할 수 있을까요?
    1. **영속성 전이( cascade )**란 특정 엔티티의 영속성 상태를 변경할 때 그 엔티티와 연관된 엔티티의 영속성에도 영향을 미쳐 영속성 상태를 변경하는 것을 의미한다.
    2. 영속성 전이 타입의 종류

    ![스크린샷 2025-03-29 오후 11.01.19.png](스크린샷%202025-03-29%20오후%2011.01.19.png)
![스크린샷 2025-03-29 오후 11.09.31.png](스크린샷%202025-03-29%20오후%2011.09.31.png)
    3. + 고아 객체
        1. 고아 객체란 부모 엔티티와 연관관계가 끊어진 엔티티
            1. orphanRemoval = true 속성을 통해 이러한 고아 객체를 자동으로 제거할 수 있다.

### 🍀 Entity는 무엇이고 생명주기는 어떻게 되나요? 생성자 패턴이 무엇일까요?

1. Entity는 무엇인가요?
    1. **Entity**란 데이터베이스에 저장된 데이터를 자바 객체로 매핑하여 인스턴스의 형태로 존재하는 데이터

    1. Entity의 생명주기는 어떻게 되나요?
        1. 비영속 → 영속성 컨텍스트에 추가되지 않은 객체의 상태
        2. 영속 → 영속성 컨텍스트에 의해 엔티티 객체가 관리되는 상태
        3. 준영속 → 영속성 컨텍스트에 의해 관리되던 엔티티 객체가 컨텍스트와 분리된 상태
        4. 삭제 → 데이터베이스에서 레코드를 삭제하기 위해 영속성 컨텍스트에 삭제 요청을 한 상태

    1. Entity에 관련된 어노테이션은 무엇이 있나요?
        1. @Entity → 해당 클래스가 JPA 엔티티임을 나타냄
        2. @Id → 엔티티 클래스의 주 식별자( Primary Key )를 지정
        3. @GeneratedValue → 자동 생성되는 기본 키를 설정
        4. @Table → 엔티티가 매핑될 데이터베이스 테이블을 명시적으로 지정
        5. @Column → 엔티티의 속성과 데이터베이스 테이블의 열을 매핑
        6. 연관 관계 매핑 어노테이션 + @JoinColum → 외래키를 지정하는 데 사용

2. Entity 객체 생성 방법으로 무엇이 있을까요?
    1. 각 생성 방법(생성자, 팩토리 메서드, 빌더 패턴)의 특징은 무엇인가요?
        1. 생성자
            1. public / protected 접근 제어자로 선언, private은 사용하지 않는다.
            2. 생성할 때 new 키워드를 사용해 객체를 생성

        2. 팩토리 메서드
            1. 객체를 생성하는 전용 메서드를 제공하는 디자인 패턴
            2. 보통 static 메서드로 제공, 객체 생성 과정을 캡슐화 할 수 있다.

        3. 빌더 패턴
            1. 생성자 대신 빌더 클래스를 사용하여 객체를 생성하는 방식
            2. 여러 매개변수를 조합하는 복잡한 작업을 캡슐화하여 가독성과 유지보수성을 높일 수 있다.


    ## 🔎 과제
    
    <aside>
    ✅ **1. 현재 널리 사용되고 있는 서비스(당근마켓, 배달의 민족, 유튜브 등)의 ERD 설계해보기**
    → 전체 서비스가 아니어도 기능 중 일부 ERD도 가능!
    
    **2. 설계된 ERD를 기반으로 Entity와 Repository Layer 구성해보기
    3. Spring과 데이터베이스 연결해보기**
    
    </aside>

- Steam ERD

![스크린샷 2025-03-29 오후 11.03.34.png](스크린샷%202025-03-29%20오후%2011.03.34.png)

![스크린샷 2025-03-29 오후 11.03.54.png](스크린샷%202025-03-29%20오후%2011.03.54.png)